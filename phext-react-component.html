<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phext Editor (F4â€“F8 Active)</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #000000;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --fg: #e0e0e0;
      }
    }
    body {
      margin: 0;
      padding: 2rem;
      font-family: monospace;
      background: var(--bg);
      color: var(--fg);
    }
    textarea {
      width: 100%;
      font-family: monospace;
    }
    .preview-scrolls {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
      overflow-x: auto;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
    }
    .preview-scroll {
      padding: 0.5rem;
      border-radius: 4px;
      min-width: 180px;
      max-width: 240px;
      scroll-snap-align: center;
      transition: all 0.3s ease-in-out;
      color: #000;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.4); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script type="module">
    import { getScroll } from './libphext.js';
  </script>

  <script>

    const { useState, useEffect, useCallback, useRef } = React;

    const parsePhextBuffer = (text) => {
      const map = {};
      text.split('---').forEach((chunk, i) => {
        map[`${i + 1},1,1,1,1,1,1,1,1`] = chunk.trim();
      });
      return map;
    };

    const duplicateScroll = () => {
      const quoted = currentScroll
        .split('\n')
        .map(line => '> ' + line)
        .join('\n');

      const target = [...address];
      target[coordIndex] = Math.min(999, target[coordIndex] + 1);

      const updated = setScroll(buffer, target, quoted);
      setBuffer(updated);
      onUpdate(target, quoted);
    };

    const stringifyPhextBuffer = (map) =>
      Object.entries(map)
        .map(([addr, scroll]) => `---\n@${addr}\n${scroll}`)
        .join('\n');

    const saveToFile = () => {
      const blob = new Blob([stringifyPhextBuffer(buffer)], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'scrolls.phext';
      a.click();
    };

    const jumpToRoot = () => {
      setAddress(Array(9).fill(1));
    };

    const getScroll = (map, addr) => map[addr.join(',')] || '';
    const setScroll = (map, addr, value) => ({ ...map, [addr.join(',')]: value });

    function App() {
      const [mode, setMode] = useState('CMM');
      const [buffer, setBuffer] = useState({ '1,1,1,1,1,1,1,1,1': 'Welcome to Phext' });
      const [address, setAddress] = useState(Array(9).fill(1));
      const [offset, setOffset] = useState(0);
      const [stride, setStride] = useState(1);
      const [coordIndex, setCoordIndex] = useState(0);
      const [currentScroll, setCurrentScroll] = useState('');
      const [overlayVisible, setOverlayVisible] = useState(false);
      const coordColors = ['#f88', '#f44', '#c00', '#88f', '#44f', '#00c', '#8f8', '#4c4', '#0c0'];

      useEffect(() => {
        const scroll = getScroll(buffer, address);
        setCurrentScroll(scroll);
        const previews = [-2, -1, 0, 1, 2].map(offset => {
          const nearby = [...address];
          nearby[coordIndex] = Math.max(1, Math.min(999, nearby[coordIndex] + offset));
          return {
            addr: [...nearby],
            content: getScroll(buffer, nearby).slice(0, 128),
            hue: coordColors[coordIndex] || '#ccc'
          };
        });
        setPreviewScrolls(previews);
        scrollContainerRef.current?.scrollTo({ left: scrollContainerRef.current.scrollWidth / 2 - 120, behavior: 'smooth' });
      }, [buffer, address, coordIndex]);

      const updateScroll = (text) => {
        const updated = setScroll(buffer, address, text);
        setBuffer(updated);
        setCurrentScroll(text);
      };

      const formatAddr = (addr) => {
        const p = [...addr, ...Array(9 - addr.length).fill(1)].slice(0, 9);
        return `${p[0]}.${p[1]}.${p[2]}/${p[3]}.${p[4]}.${p[5]}/${p[6]}.${p[7]}.${p[8]}`;
      }

      const jumpToRoot = () => setAddress(Array(9).fill(1));
      const toggleOverlay = () => setOverlayVisible(v => !v);

      useEffect(() => {
        setCurrentScroll(getScroll(buffer, address));
      }, [buffer, address]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key.startsWith('F')) e.preventDefault(); // Stop browser default F-key actions
          if (e.key === 'F4') updateScroll('');
          if (e.key === 'F5') duplicateScroll();
          if (e.key === 'F6') saveToFile();
          if (e.key === 'F7') jumpToRoot();
          if (e.key === 'F8') toggleOverlay();
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [currentScroll]);

      return React.createElement('div', {}, [
        overlayVisible &&
          React.createElement('div', {
            style: {
              position: 'fixed',
              top: 0,
              left: 0,
              width: '100vw',
              height: '100vh',
              backdropFilter: 'blur(8px)',
              background: 'rgba(0, 0, 0, 0.75)',
              zIndex: 9999,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              fontFamily: 'monospace',
              color: '#0f0',
            }
          }, [
            React.createElement('div', { style: { fontSize: '2rem', marginBottom: '1rem' } }, 'Coordinate Overlay Active (F8 to hide)'),
            React.createElement('div', { style: { display: 'flex', gap: '1rem' } },
              coordColors.map((color, i) =>
                React.createElement('div', {
                  key: i,
                  style: {
                    width: '24px',
                    height: '24px',
                    borderRadius: '50%',
                    background: color,
                    animation: 'pulse 1.5s infinite ease-in-out',
                    animationDelay: `${i * 0.1}s`,
                  }
                })
              )
            )
          ]),
        React.createElement('textarea', {
          rows: 20,
          cols: 80,
          value: currentScroll,
          onChange: (e) => updateScroll(e.target.value),
          style: { marginTop: '1rem' }
        })
      ]);
    }

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>
